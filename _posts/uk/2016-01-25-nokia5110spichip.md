---
title: Екран від Nokia 5110 для CHIP
abstract: Для одного з моїх проектів у мене з’явилась потреба у маленькому недорогому екрану для CHIP, тому я намагаюсь під’єднати дисплей від Nokia 5110 через шину SPI як фреймбуфер, а потім висвітлити на ньому зображення та консольні програми під ncurses.
---

# Налаштування апаратної частини
Використано наступне обладнання:

- [Комп’ютер CHIP](http://getchip.com/ "NextThingCo, виробник CHIP"), Alpha v0x21
- [Блок екрана Nokia 5110](http://arduino-ua.com/prod407-Nokia5110_LCD_modyl "Магазин ARDUINO-UA")
- [Макетна плата на 2 колії живлення](http://arduino-ua.com/prod361-Maketnaya_plata_bolshaya "Магазин ARDUINO-UA")
- [Блок живлення-трансформатор від 6.5-12В AC до 3.3/5В DC](http://arduino-ua.com/prod287-Pitanie_dlya_maketnoi_plati_533V "Магазин ARDUINO-UA")
- [Кабелі-перемички](http://arduino-ua.com/prod522-Nabor_peremichek_dlya_Arduino_40_sht "Магазин ARDUINO-UA")
- Блок живлення від 100-240В до 9В, 1.2 А

### Екран та його проводка
Підключення до макетної плати вкрай просте. Єдиний нюанс полягає в тім, що екран існує в белзічі варіантів виконання,
тому вказівки для підключення з Інтернету можуть трохи відрізнятись від вашого пристрою. В моєму випадку я під’єднав
`VCC` до живлення 3.3В (+), а `GND` та `LIGHT` до землі 3.3В (-). Судячи з усього, декотрі екрани натомість потребують
підключення `LIGHT` до (+).

{% include figure.html url="IMG_20160125_121724.jpg" caption="Під’єднаний та увімкнений екран" %}

### Підключення CHIP
Зазвичай для CHIP вистачає живлення від кабеля μUSB, що здатен видавати 500 мАг струму. Щоправда у мене пристрій
інколи вимикається, коли я під’єдную його до задовгого кабеля і використовую енергоємні задачі такі як WiFi, тому я
також приєднав 5В живлення з макетної плати. Відповідно до [цокольовки][chippinout], підєднуємо (+) живлення до `CHG-IN`,
а землю (-) до `GND`, виходи 2 та 4 на цоколі `U13` відповідно. Я не довіряю джерелу живлення у тому, що земля на 3.3В
збігається із землею на 5.5В, тому я також перепід’єднав живлення екрану до власних виходів живлення CHIP. Таким чином,
приєднуємо `LIGHT` та `GND` до `GND`, а `VCC` до `VCC3V3` (`U13`, виходи 1 та 5 відповідно).

CHIP дає у доступ [лише SPI2][spi2forum] та його виходи суміщені із інтерфейсом CSI, тому щоби використати SPI маємо
пожертувати функціоналом камери. З огляду на [схему][chipschema], SPI потрібно під’єднувати наступним чином: `CSIPCK`
до `CE`, `CSICK` до `CLK`, `CSIHSYNC` до `DIN` (`U14` виходи 27-29 відповідно ). CHIP має виходи на 3.3В, тому на щастя
не потрібно використовувати блок перекладу рівнів. Але якщо ваша плата на 5В, то використати його таки доведеться.

Тепер лишається 2 невикористані входи на екрані: `RST`, через який прилад перезавантажується, та `DC` для перемикання
між режимом команд і режимом даних. Вони не входять в інтерфейс SPI, тому їх треба під’єднати до виходів GPIO. Оскільки нам
не так суттєва швидкість, то найпростіше буде використати виходи `XIO`, отже під’єднуємо: `XIO-P0` до `RST`, `XIO-P1` до `DC`
(`U14` виходи 13-14 відповідно). Запам’ятаймо номери, вони ще знадобляться.

[chippinout]: https://github.com/NextThingCo/CHIP-Hardware/blob/master/ALPHA-CHIP%5Bv0_21%5D/ALPHA%20CHIP%20v0_21%20PINOUT.png
[chipschema]: https://github.com/NextThingCo/CHIP-Hardware/blob/master/ALPHA-CHIP%5Bv0_21%5D/CHIP_ALPHA_V_021.pdf
[spi2forum]: https://bbs.nextthing.co/t/spi-master-support/1118/5

{% include figure.html url="IMG_20160125_142912.jpg" caption="Кінцева схема підключення CHIP" %}

# Налаштування програмного забезпечення
Нарешті проводи під’єднано і потрібно зконфігурвати Linux для підтримки SPI та використання нашого екрану у якості
фреймбуфера. Вказівки з підлаштунків прошивки можна знайти у [офіційній документації][chipsdk], не буду тут повторювати ази.
Можливо використати власний крос-компліятор, якщо ви знаєте про що йдеться та ще й не ліниві.

[chipsdk]: http://docs.getchip.com/#flash-chip-firmware

### Ядро та дерево пристроїв
Перевіряємо потрібні опції ядра. Якщо ваше ядро вже має включені `SPI`, `FB` та `GPIOLIB`, можна лише зкомпілювати модуль
`fbtft` від @notro без повної перезборки. Він присутній у версії ядра для CHIP' у каталозі `drivers/staging`. Також, ядро
викорисовує [файл дерева пристроїв][gpiomux] для визначення апаратної конфігурації, дому ми маємо в ньому вказати підтримку
SPI2. Раджу [цю гілку][dtsforum] для детального ознайомлення. Також можна зкомпліювати дерево пристроїв власноруч
за допомогою утиліти `dtc` також без зборки ядра. Для зручності я зробив свою копію `CHIP-linux` та використовую під час
зборки мій репозиторій із додатковим файлом `defconfig`:

```
CHIP-buildroot$ make menuconfig
```

```
[*] Linux Kernel                              
  Kernel version (Custom Git repository)  --->   
  (https://github.com/landswellsong/CHIP-linux.git) URL of custom repository
  Kernel configuration (Using an in-tree defconfig file)  --->
  (chip_spi2_fbtft) Defconfig name
```

```
CHIP-buildroot$ make linux
```

Відносно стандартного ядра змінено наступне:

- Конфігурація CHIP винесана у файл `arch/arm/configs/chip_spi2_fbtft_defconfig`, в ній включений `FB_TFT` як модуль.
- Дерево пристроїв із [змінами][dts] від @vmayoral.

Коли ваше ядро буде готово, візьміть файли `zImage` й `sun5i-r8-chip.dtb` з `output/images`, а також `lib/modules`
з `output/target` й покладіть їх на пристрій у каталоги `/boot` та `/lib` відповідно, й перезавантажте CHIP. Також можна
зробити повну перепрошивку згідно до документації. Зайдіть у нову систему і в журналі має бути наступне:

```
chip# dmesg
```

Перед завантаженням модуля, потрібно дізнатись як виходи названі у ядрі відповідні виходи GPIO. В моєму випадку `XIO-P0` це
408, а `XIO-P1` це 409. Надішліть на них значення 0/1 та перевірте, що напруга між відповідним виходом та `GND` становитиме
0/3.3В. @jefflarkin розробив зручний [скрипт bash][gpioforum] якщо ви не знаєтесь на `/sys/class/gpio`.
Коли всі значення встановлені, загружаємо модуль у ядро:

[gpiomux]: https://bbs.nextthing.co/t/muxing-chip-gpios/300/8
[dtsforum]: https://bbs.nextthing.co/t/get-several-spi-chip-selects/895
[dts]: https://github.com/landswellsong/CHIP-linux/commit/9400252965925d02de5b12996141b7f5b44ec9f1
[gpioforum]: https://bbs.nextthing.co/t/bash-interface-to-gpio/2144

### Framebuffer setup
